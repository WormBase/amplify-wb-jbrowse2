"use strict";(globalThis.webpackChunk_jbrowse_web=globalThis.webpackChunk_jbrowse_web||[]).push([[2947],{52947:(e,t,n)=>{n.r(t),n.d(t,{default:()=>k});var s=n(46377),r=n(6434),o=n(66885),a=n(82088),i=n(44728),c=n(86576),p=n(99546),d=n(37347),f=n(95805),u=n(93092);function g(e){return b(e.type)?1:e.length}function b(e){return"softclip"===e||"hardclip"===e||"insertion"===e}function l(e,t,n,s){let r=e[n][s];void 0===r&&(r=e[n][s]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),r.entryDepth++,r[t]++}function h(e,t,n,s,r){let o=e[n][s];void 0===o&&(o=e[n][s]={entryDepth:0,probabilities:[],"-1":0,0:0,1:0}),o.entryDepth++,o.probabilities.push(r),o[t]++}function m({feature:e,region:t,bins:n,regionSequence:s}){const r=e.get("start"),o=e.get("end"),a=e.get("strand"),i=e.get("seq"),c=e.get("mismatches")??[],d=s.toLowerCase();if(i){const s=(0,f.parseCigar)(e.get("CIGAR")),{methBins:i,methProbs:g}=(0,u.Ps)(e,s),b=c.filter((e=>"deletion"===e.type));for(let e=0;e<o-r;e++){const s=e+r,o=d[s-t.start+1],c=d[s-t.start+2];if("c"===o&&"g"===c){const o=n[s-t.start],c=n[s-t.start+1],d=i[e],f=i[e+1],u=g[e],l=g[e+1];d&&(void 0===u||u>.5)||f&&(void 0===l||l>.5)?(o&&(h(o,a,"mods","cpg_meth",u||0),o.ref.entryDepth--,o.ref[a]--),c&&(h(c,a,"mods","cpg_meth",l||0),c.ref.entryDepth--,c.ref[a]--)):(o&&(b.some((e=>(0,p.doesIntersect2)(s,s+1,e.start+r,e.start+r+e.length)))||(h(o,a,"nonmods","cpg_unmeth",1-(u||0)),o.ref.entryDepth--,o.ref[a]--)),c&&(b.some((e=>(0,p.doesIntersect2)(s+1,s+2,e.start+r,e.start+r+e.length)))||(h(c,a,"nonmods","cpg_unmeth",1-(l||0)),c.ref.entryDepth--,c.ref[a]--)))}}}}var y=n(59509);function w({feature:e,colorBy:t,region:n,bins:s,regionSequence:r}){const o=e.get("start"),a=e.get("strand"),i=e.get("end"),c=t?.modifications?.twoColor,d=t?.modifications?.isolatedModification;(0,y.r)(e)?.forEach((({type:e,prob:t,allProbs:f},u)=>{if(d&&e!==d)return;const g=u+o-n.start;if(g>=0&&g<s.length&&u+o<i){void 0===s[g]&&(s[g]={depth:0,readsCounted:0,refbase:r[g],snps:{},ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},mods:{},nonmods:{},delskips:{},noncov:{}});const n=1-(0,p.sum)(f),o=s[g];c&&n>(0,p.max)(f)?h(o,a,"nonmods",`nonmod_${e}`,n):h(o,a,"mods",`mod_${e}`,t)}}))}function v({feature:e,bins:t,region:n,regionSequence:s}){const r=e.get("start"),o=e.get("end"),a=e.get("strand"),i=n.end-n.start;for(let e=r;e<o+1;e++){const r=e-n.start;r>=0&&r<i&&(void 0===t[r]&&(t[r]={depth:0,readsCounted:0,refbase:s[r],ref:{probabilities:[],entryDepth:0,"-1":0,0:0,1:0},snps:{},mods:{},nonmods:{},delskips:{},noncov:{}}),e!==o&&(t[r].depth++,t[r].readsCounted++,t[r].ref.entryDepth++,t[r].ref[a]++))}}function S({feature:e,region:t,bins:n,skipmap:s}){const r=e.get("start"),o=e.get("strand"),a=e.get("mismatches")??[];for(const i of a){const a=r+i.start,c=g(i),p=a+c;for(let e=a;e<a+c;e++){const s=e-t.start;if(s>=0&&s<n.length){const e=n[s],{base:t,type:r}=i,a=b(r);"deletion"===r||"skip"===r?(l(e,o,"delskips",r),e.depth--):a?l(e,o,"noncov",r):(l(e,o,"snps",t),e.ref.entryDepth--,e.ref[o]--)}}if("skip"===i.type){const t=e.get("tags"),n=t?.XS||t?.TS,r=t?.ts,i="+"===n?1:"-"===n?-1:("+"===r?1:"-"===n?-1:0)*o,c=`${a}_${p}_${i}`;void 0===s[c]&&(s[c]={feature:e,start:a,end:p,strand:o,effectiveStrand:i,score:0}),s[c].score++}}}class k extends s.BaseFeatureDataAdapter{async configure(){const e=this.getConf("subadapter"),t=e.sequenceAdapter,n=await(this.getSubAdapter?.(e)),s=t?await(this.getSubAdapter?.(t)):void 0;if(!n)throw new Error("Failed to get subadapter");return{subadapter:n.dataAdapter,sequenceAdapter:s?.dataAdapter}}async fetchSequence(e){const{sequenceAdapter:t}=await this.configure();if(t)return(0,c.Iw)(e,t)}getFeatures(e,t={}){return(0,o.ObservableCreate)((async n=>{const{subadapter:s}=await this.configure(),o=await(0,i._)(s.getFeatures(e,t).pipe((0,a.$)())),{bins:c,skipmap:f}=await async function({fetchSequence:e,features:t,region:n,opts:s}){const{stopToken:r,colorBy:o}=s,a={},i=[],c=Math.max(0,n.start-1),f=n.start-c,u=await e({...n,start:c,end:n.end+1})||"";let g=performance.now();for(const e of t)performance.now()-g>400&&((0,d.SW)(r),g=performance.now()),v({feature:e,bins:i,region:n,regionSequence:u.slice(f)}),"modifications"===o?.type?w({feature:e,colorBy:o,bins:i,region:n,regionSequence:u.slice(f)}):"methylation"===o?.type&&m({feature:e,bins:i,region:n,regionSequence:u}),S({feature:e,skipmap:a,bins:i,region:n});for(const e of i)e&&(e.mods=Object.fromEntries(Object.entries(e.mods).map((([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,p.sum)(t.probabilities)/t.probabilities.length:void 0}]))),e.nonmods=Object.fromEntries(Object.entries(e.nonmods).map((([e,t])=>[e,{...t,avgProbability:t.probabilities.length?(0,p.sum)(t.probabilities)/t.probabilities.length:void 0}]))));return{bins:i,skipmap:a}}({features:o,region:e,opts:t,fetchSequence:e=>this.fetchSequence(e)});c.forEach(((t,s)=>{const o=e.start+s;n.next(new r.A({id:`${this.id}-${o}`,data:{score:t.depth,snpinfo:t,start:o,end:o+1,refName:e.refName}}))})),Object.entries(f).forEach((([e,t])=>{n.next(new r.A({id:e,data:{type:"skip",start:t.start,end:t.end,strand:t.strand,score:t.score,effectiveStrand:t.effectiveStrand}}))})),n.complete()}),t.stopToken)}async getMultiRegionFeatureDensityStats(e,t){const{subadapter:n}=await this.configure();return n.getMultiRegionFeatureDensityStats(e,t)}async getRefNames(e={}){const{subadapter:t}=await this.configure();return t.getRefNames(e)}freeResources(){}}},59509:(e,t,n)=>{n.d(t,{r:()=>i});var s=n(93092),r=n(95805),o=n(49256),a=n(86576);function i(e,t){const n=e.get("strand"),i=e.get("seq"),c=(0,a.c$)(e,"MM","Mm")||"",p=t||(0,r.parseCigar)(e.get("CIGAR"));if(i){const t=(0,s.Z1)(c,i,n),r=(0,s.Yj)(e),a=[];let d=0;for(const{type:e,positions:s}of t){for(const{ref:t,idx:i}of(0,o.h)(p,s)){const o=r?.[d+(-1===n?s.length-1-i:i)]||0;if(a[t]){const n=a[t];a[t]={allProbs:[...n.allProbs,o],prob:Math.max(n.prob,o),type:n.prob>o?n.type:e}}else a[t]={type:e,prob:o,allProbs:[o]}}d+=s.length}return a}}}}]);
//# sourceMappingURL=2947.4c2da041.chunk.js.map