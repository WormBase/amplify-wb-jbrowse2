{"version":3,"file":"static/js/7576.3ef8cc80.chunk.js","mappings":"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","sources":["../../../plugins/alignments/src/SNPCoverageAdapter/generateCoverageBins.ts","../../../plugins/alignments/src/SNPCoverageAdapter/SNPCoverageAdapter.ts"],"sourcesContent":["import { AugmentedRegion as Region } from '@jbrowse/core/util/types'\nimport { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { getTag, getTagAlt, shouldFetchReferenceSequence } from '../util'\nimport {\n  parseCigar,\n  getNextRefPos,\n  getModificationPositions,\n  getMethBins,\n  Mismatch,\n} from '../MismatchParser'\nimport { doesIntersect2 } from '@jbrowse/core/util'\nimport { Bin, SkipMap } from './util'\n\nfunction mismatchLen(mismatch: Mismatch) {\n  return !isInterbase(mismatch.type) ? mismatch.length : 1\n}\n\nfunction isInterbase(type: string) {\n  return type === 'softclip' || type === 'hardclip' || type === 'insertion'\n}\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nfunction inc(bin: any, strand: number, type: string, field: string) {\n  let thisBin = bin[type][field]\n  if (thisBin === undefined) {\n    thisBin = bin[type][field] = {\n      total: 0,\n      '-1': 0,\n      '0': 0,\n      '1': 0,\n    }\n  }\n  thisBin.total++\n  thisBin[strand]++\n}\n\nexport default async function generateCoverageBins(\n  features: Feature[],\n  region: Region,\n  opts: { bpPerPx?: number; colorBy?: { type: string; tag?: string } },\n  fetchSequence: (arg: Region) => Promise<string>,\n) {\n  const { colorBy } = opts\n  const extendedRegion = {\n    ...region,\n    start: Math.max(0, region.start - 1),\n    end: region.end + 1,\n  }\n  const binMax = Math.ceil(extendedRegion.end - extendedRegion.start)\n  const skipmap = {} as SkipMap\n  const regionSequence =\n    features.length && shouldFetchReferenceSequence(opts.colorBy?.type)\n      ? await fetchSequence(region)\n      : undefined\n\n  const bins = [] as Bin[]\n\n  for (const feature of features) {\n    const fstart = feature.get('start')\n    const fend = feature.get('end')\n    const fstrand = feature.get('strand') as -1 | 0 | 1\n    const mismatches = (feature.get('mismatches') as Mismatch[]) || []\n\n    for (let j = fstart; j < fend + 1; j++) {\n      const i = j - region.start\n      if (i >= 0 && i < binMax) {\n        if (bins[i] === undefined) {\n          bins[i] = {\n            total: 0,\n            all: 0,\n            ref: 0,\n            '-1': 0,\n            '0': 0,\n            '1': 0,\n            lowqual: {},\n            cov: {},\n            delskips: {},\n            noncov: {},\n          }\n        }\n        if (j !== fend) {\n          bins[i].total++\n          bins[i].all++\n          bins[i].ref++\n          bins[i][fstrand]++\n        }\n      }\n    }\n\n    if (colorBy?.type === 'modifications') {\n      const seq = feature.get('seq') as string | undefined\n      const mm = (getTagAlt(feature, 'MM', 'Mm') as string) || ''\n      const ops = parseCigar(feature.get('CIGAR'))\n      const fend = feature.get('end')\n      if (seq) {\n        const modifications = getModificationPositions(mm, seq, fstrand)\n        for (const { type, positions } of modifications) {\n          const mod = `mod_${type}`\n          for (const pos of getNextRefPos(ops, positions)) {\n            const epos = pos + fstart - region.start\n            if (epos >= 0 && epos < bins.length && pos + fstart < fend) {\n              if (bins[epos] === undefined) {\n                bins[epos] = {\n                  total: 0,\n                  all: 0,\n                  ref: 0,\n                  '-1': 0,\n                  '0': 0,\n                  '1': 0,\n                  lowqual: {},\n                  cov: {},\n                  delskips: {},\n                  noncov: {},\n                }\n              }\n              const bin = bins[epos]\n              if (bin) {\n                inc(bin, fstrand, 'cov', mod)\n              } else {\n                console.warn(\n                  'Undefined position in modifications snpcoverage encountered',\n                )\n              }\n            }\n          }\n        }\n      }\n    }\n\n    if (colorBy?.type === 'methylation') {\n      if (!regionSequence) {\n        throw new Error(\n          'no region sequence detected, need sequenceAdapter configuration',\n        )\n      }\n      const seq = feature.get('seq') as string | undefined\n      if (!seq) {\n        continue\n      }\n      const { methBins, methProbs } = getMethBins(feature)\n      const dels = mismatches.filter(f => f.type === 'deletion')\n\n      // methylation based coloring takes into account both reference sequence\n      // CpG detection and reads\n      for (let i = 0; i < fend - fstart; i++) {\n        const j = i + fstart\n        const l1 = regionSequence[j - region.start + 1]?.toLowerCase()\n        const l2 = regionSequence[j - region.start + 2]?.toLowerCase()\n        if (l1 === 'c' && l2 === 'g') {\n          const bin0 = bins[j - region.start]\n          const bin1 = bins[j - region.start + 1]\n          const b0 = methBins[i]\n          const b1 = methBins[i + 1]\n          const p0 = methProbs[i]\n          const p1 = methProbs[i + 1]\n\n          // color\n          if (\n            (b0 && (p0 !== undefined ? p0 > 0.5 : true)) ||\n            (b1 && (p1 !== undefined ? p1 > 0.5 : true))\n          ) {\n            if (bin0) {\n              inc(bin0, fstrand, 'cov', 'meth')\n              bin0.ref--\n              bin0[fstrand]--\n            }\n            if (bin1) {\n              inc(bin1, fstrand, 'cov', 'meth')\n              bin1.ref--\n              bin1[fstrand]--\n            }\n          } else {\n            if (bin0) {\n              if (\n                !dels?.some(d =>\n                  doesIntersect2(\n                    j,\n                    j + 1,\n                    d.start + fstart,\n                    d.start + fstart + d.length,\n                  ),\n                )\n              ) {\n                inc(bin0, fstrand, 'cov', 'unmeth')\n                bin0.ref--\n                bin0[fstrand]\n              }\n            }\n            if (bin1) {\n              if (\n                !dels?.some(d =>\n                  doesIntersect2(\n                    j + 1,\n                    j + 2,\n                    d.start + fstart,\n                    d.start + fstart + d.length,\n                  ),\n                )\n              ) {\n                inc(bin1, fstrand, 'cov', 'unmeth')\n                bin1.ref--\n                bin1[fstrand]--\n              }\n            }\n          }\n        }\n      }\n    }\n\n    // normal SNP based coloring\n    const colorSNPs =\n      colorBy?.type !== 'modifications' && colorBy?.type !== 'methylation'\n\n    for (const mismatch of mismatches) {\n      const mstart = fstart + mismatch.start\n      const mlen = mismatchLen(mismatch)\n      const mend = mstart + mlen\n      for (let j = mstart; j < mstart + mlen; j++) {\n        const epos = j - region.start\n        if (epos >= 0 && epos < bins.length) {\n          const bin = bins[epos]\n          const { base, type } = mismatch\n          const interbase = isInterbase(type)\n          if (!interbase) {\n            bin.ref--\n            bin[fstrand]--\n          } else {\n            inc(bin, fstrand, 'noncov', type)\n          }\n\n          if (type === 'deletion' || type === 'skip') {\n            inc(bin, fstrand, 'delskips', type)\n            bin.total--\n          } else if (!interbase && colorSNPs) {\n            inc(bin, fstrand, 'cov', base)\n            bin.refbase = mismatch.altbase\n          }\n        }\n      }\n\n      if (mismatch.type === 'skip') {\n        const hash = `${mstart}_${mend}_${fstrand}`\n        if (skipmap[hash] === undefined) {\n          skipmap[hash] = {\n            feature: feature,\n            start: mstart,\n            end: mend,\n            strand: fstrand,\n            xs: getTag(feature, 'XS') || getTag(feature, 'TS'),\n            score: 0,\n          }\n        }\n        skipmap[hash].score++\n      }\n    }\n  }\n\n  return { bins, skipmap }\n}\n","import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { AugmentedRegion as Region } from '@jbrowse/core/util/types'\nimport SimpleFeature, { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { toArray } from 'rxjs/operators'\nimport { firstValueFrom } from 'rxjs'\n\n// locals\nimport generateCoverageBins from './generateCoverageBins'\nimport { fetchSequence } from '../util'\n\nexport default class SNPCoverageAdapter extends BaseFeatureDataAdapter {\n  protected async configure() {\n    const subadapterConfig = this.getConf('subadapter')\n    const sequenceConf = subadapterConfig.sequenceAdapter\n    const dataAdapter = await this.getSubAdapter?.(subadapterConfig)\n\n    const sequenceAdapter = sequenceConf\n      ? await this.getSubAdapter?.(sequenceConf)\n      : undefined\n\n    if (!dataAdapter) {\n      throw new Error('Failed to get subadapter')\n    }\n\n    return {\n      subadapter: dataAdapter.dataAdapter as BaseFeatureDataAdapter,\n      sequenceAdapter: sequenceAdapter?.dataAdapter as\n        | BaseFeatureDataAdapter\n        | undefined,\n    }\n  }\n\n  async fetchSequence(region: Region) {\n    const { sequenceAdapter } = await this.configure()\n    if (!sequenceAdapter) {\n      return undefined\n    }\n\n    return fetchSequence(region, sequenceAdapter)\n  }\n\n  getFeatures(region: Region, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      const { subadapter } = await this.configure()\n      const feats = await firstValueFrom(\n        subadapter.getFeatures(region, opts).pipe(toArray()),\n      )\n\n      const { bins, skipmap } = await generateCoverageBins(\n        feats,\n        region,\n        opts,\n        arg => this.fetchSequence(arg),\n      )\n\n      bins.forEach((bin, index) => {\n        const start = region.start + index\n        observer.next(\n          new SimpleFeature({\n            id: `${this.id}-${start}`,\n            data: {\n              score: bin.total,\n              snpinfo: bin,\n              start,\n              end: start + 1,\n              refName: region.refName,\n            },\n          }),\n        )\n      })\n\n      // make fake features from the coverage\n      Object.entries(skipmap).forEach(([key, skip]) => {\n        observer.next(\n          new SimpleFeature({\n            id: key,\n            data: {\n              type: 'skip',\n              start: skip.start,\n              end: skip.end,\n              strand: skip.strand,\n              score: skip.score,\n              xs: skip.xs,\n            },\n          }),\n        )\n      })\n\n      observer.complete()\n    }, opts.signal)\n  }\n\n  async getMultiRegionFeatureDensityStats(\n    regions: Region[],\n    opts?: BaseOptions,\n  ) {\n    const { subadapter } = await this.configure()\n    return subadapter.getMultiRegionFeatureDensityStats(regions, opts)\n  }\n\n  async getRefNames(opts: BaseOptions = {}) {\n    const { subadapter } = await this.configure()\n    return subadapter.getRefNames(opts)\n  }\n\n  freeResources(/* { region } */): void {}\n}\n"],"names":["mismatchLen","mismatch","isInterbase","type","length","inc","bin","strand","field","thisBin","undefined","total","generateCoverageBins","_x","_x2","_x3","_x4","_generateCoverageBins","_asyncToGenerator","_regeneratorRuntime","mark","_callee","features","region","opts","fetchSequence","_opts$colorBy","colorBy","extendedRegion","binMax","skipmap","regionSequence","bins","_iterator","_step","_loop","wrap","_context3","prev","next","_objectSpread","start","Math","max","end","ceil","shouldFetchReferenceSequence","t0","sent","_createForOfIteratorHelper","feature","fstart","fend","fstrand","mismatches","j","i","seq","mm","ops","_fend","modifications","_iterator2","_step2","_step2$value","positions","mod","_iterator3","_step3","pos","epos","_getMethBins","methBins","methProbs","dels","_loop2","_i","colorSNPs","_iterator4","_step4","mstart","mlen","mend","_j","_epos","_bin","base","_type","interbase","hash","_context2","value","get","all","ref","lowqual","cov","delskips","noncov","getTagAlt","parseCigar","getModificationPositions","s","n","done","concat","getNextRefPos","console","warn","err","e","f","Error","abrupt","getMethBins","filter","_regionSequence","_regionSequence2","l1","l2","bin0","bin1","b0","b1","p0","p1","_context","toLowerCase","some","d","doesIntersect2","stop","delegateYield","refbase","altbase","xs","getTag","score","t1","t2","finish","apply","arguments","SNPCoverageAdapter","_BaseFeatureDataAdapt","_configure","_fetchSequence2","_getMultiRegionFeatureDensityStats","_getRefNames","_inherits","_super","_createSuper","_classCallCheck","_createClass","key","_this$getSubAdapter","_this$getSubAdapter2","subadapterConfig","sequenceConf","dataAdapter","sequenceAdapter","this","getConf","getSubAdapter","call","subadapter","_callee2","_yield$this$configure","configure","_ref","_this","ObservableCreate","_callee3","observer","_yield$_this$configur","feats","_yield$generateCovera","firstValueFrom","getFeatures","pipe","toArray","arg","forEach","index","SimpleFeature","id","data","snpinfo","refName","Object","entries","_ref2","_ref3","_slicedToArray","skip","complete","signal","_callee4","regions","_yield$this$configure2","_context4","getMultiRegionFeatureDensityStats","_callee5","_yield$this$configure3","_args5","_context5","getRefNames","BaseFeatureDataAdapter"],"sourceRoot":""}