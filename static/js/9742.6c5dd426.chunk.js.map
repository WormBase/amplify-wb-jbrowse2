{"version":3,"file":"static/js/9742.6c5dd426.chunk.js","mappings":"oOAyCA,MAAMA,EACJC,WAAAA,CAAoBC,GAAgC,KAAhCA,WAAAA,CAAgC,CAEpD,UAAMC,CAAKC,EAAkBC,GAC3B,MAAQC,OAAQC,EAAC,UAAEC,SAAoBC,KAAKP,WAAWC,KACrDO,EAAOC,YAAYN,GACnB,EACAA,EACAD,GAGF,OAAOG,EAAED,OAAOM,MAAML,EAAEM,WAAYN,EAAEM,WAAaL,EACrD,EAEK,SAASM,EACdC,EACAC,GAEA,OAAO,IAAIhB,GAAyBiB,EAAAA,EAAAA,cAAaF,EAAUC,GAC7D,CAae,MAAME,UAAmBC,EAAAA,uBAG/BlB,WAAAA,CACLmB,EACAC,EACAL,GAEAM,MAAMF,EAAQC,EAAeL,GAAc,KAPrCO,SAAG,EAQT,MAAMC,EAAcf,KAAKgB,QAAQ,eACjChB,KAAKc,IAAM,IAAIG,EAAAA,EAAS,CACtBC,KAAMb,EAAsBU,EAAaf,KAAKO,gBAElD,CAEA,WAAcY,CAAMC,GAClB,MAAM,eAAEC,EAAiBA,UAAaD,GAAQ,CAAC,EAC/CC,EAAe,2BACf,MAAMC,QAAetB,KAAKc,IAAIS,cAE9B,OADAF,EAAe,IACRC,CACT,CAEA,eAAaE,CAAUJ,GACrB,MAAMK,QAAYzB,KAAKmB,MAAMC,IACvB,YAAEM,KAAgBC,GAASF,EACjC,OAAOE,CACT,CAEA,iBAAMC,CAAYR,GAEhB,aADuBpB,KAAKmB,MAAMC,IAClBM,YAAYG,KAAIC,GAAOA,EAAIC,MAC7C,CAEA,mBAAMC,CAAcC,EAAiBb,GACnC,MAAM,YAAEc,SAAsBlC,KAAKmB,MAAMC,GAEzC,IAAIe,EAAmBD,EAAYE,IAAI,GAEvC,IAAK,IAAIC,EAAIH,EAAYtC,OAAS,EAAGyC,GAAK,EAAGA,GAAK,EAAG,CACnD,MAAMC,EAAIJ,EAAYG,GAClBC,GAAK,EAAIL,IACXE,EAAmBG,EAEvB,CACA,OAAOH,CACT,CAEAI,WAAAA,CAAYC,GAAwC,IAAxBpB,EAAgBqB,UAAA7C,OAAA,QAAA8C,IAAAD,UAAA,GAAAA,UAAA,GAAG,CAAC,EAC9C,OAAOE,EAAAA,EAAAA,mBAAgCC,UACrC,MAAQC,QAASf,EAAG,MAAEgB,EAAK,IAAEC,GAAQP,GAC/B,WAAEQ,EAAU,QAAEf,EAAU,EAAC,eAAEZ,EAAiBA,UAAaD,EACzD6B,QAAYjD,KAAKgC,cAAcC,GAAWe,GAAc,KAAO5B,GACrEC,EAAe,gCAEOrB,KAAKc,IAAIoC,kBAC7B,KACA,CAAEJ,QAAOhB,MAAKiB,OACd,CAAED,QAAOhB,MAAKiB,OACd,KACAE,IAEME,SAAQC,IACdC,EAASC,KAAKF,EAAO,IAEvB/B,EAAe,IACfgC,EAASE,UAAU,GAClBnC,EAAKoC,OACV,CAGA,uCAAMC,CAAkCC,GACtC,MAAO,CAAEC,eAAgB,EAC3B,CAEAC,aAAAA,GAAuC,E","sources":["../../../plugins/hic/src/HicAdapter/HicAdapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { Region, FileLocation } from '@jbrowse/core/util/types'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport type { GenericFilehandle } from 'generic-filehandle'\nimport HicStraw from 'hic-straw'\nimport PluginManager from '@jbrowse/core/PluginManager'\nimport { getSubAdapterType } from '@jbrowse/core/data_adapters/dataAdapterCache'\nimport { AnyConfigurationModel } from '@jbrowse/core/configuration'\n\ninterface ContactRecord {\n  bin1: number\n  bin2: number\n  counts: number\n}\n\ninterface HicMetadata {\n  chromosomes: {\n    name: string\n    length: number\n    id: number\n  }[]\n  resolutions: number[]\n}\ninterface Ref {\n  chr: string\n  start: number\n  end: number\n}\n\ninterface HicOptions extends BaseOptions {\n  resolution?: number\n  bpPerPx?: number\n}\n\n// wraps generic-filehandle so the read function only takes a position and length\n// in some ways, generic-filehandle wishes it was just this but it has\n// to adapt to the node.js fs promises API\nclass GenericFilehandleWrapper {\n  constructor(private filehandle: GenericFilehandle) {}\n\n  async read(position: number, length: number) {\n    const { buffer: b, bytesRead } = await this.filehandle.read(\n      Buffer.allocUnsafe(length),\n      0,\n      length,\n      position,\n    )\n    // xref https://stackoverflow.com/a/31394257/2129219\n    return b.buffer.slice(b.byteOffset, b.byteOffset + bytesRead)\n  }\n}\nexport function openFilehandleWrapper(\n  location: FileLocation,\n  pluginManager?: PluginManager,\n) {\n  return new GenericFilehandleWrapper(openLocation(location, pluginManager))\n}\n\ninterface HicParser {\n  getContactRecords: (\n    normalize: string,\n    ref: Ref,\n    ref2: Ref,\n    units: string,\n    binsize: number,\n  ) => Promise<ContactRecord[]>\n  getMetaData: () => Promise<HicMetadata>\n}\n\nexport default class HicAdapter extends BaseFeatureDataAdapter {\n  private hic: HicParser\n\n  public constructor(\n    config: AnyConfigurationModel,\n    getSubAdapter?: getSubAdapterType,\n    pluginManager?: PluginManager,\n  ) {\n    super(config, getSubAdapter, pluginManager)\n    const hicLocation = this.getConf('hicLocation')\n    this.hic = new HicStraw({\n      file: openFilehandleWrapper(hicLocation, this.pluginManager),\n    })\n  }\n\n  private async setup(opts?: BaseOptions) {\n    const { statusCallback = () => {} } = opts || {}\n    statusCallback('Downloading .hic header')\n    const result = await this.hic.getMetaData()\n    statusCallback('')\n    return result\n  }\n\n  public async getHeader(opts?: BaseOptions) {\n    const ret = await this.setup(opts)\n    const { chromosomes, ...rest } = ret\n    return rest\n  }\n\n  async getRefNames(opts?: BaseOptions) {\n    const metadata = await this.setup(opts)\n    return metadata.chromosomes.map(chr => chr.name)\n  }\n\n  async getResolution(bpPerPx: number, opts?: BaseOptions) {\n    const { resolutions } = await this.setup(opts)\n\n    let chosenResolution = resolutions.at(-1)!\n\n    for (let i = resolutions.length - 1; i >= 0; i -= 1) {\n      const r = resolutions[i]\n      if (r <= 2 * bpPerPx) {\n        chosenResolution = r\n      }\n    }\n    return chosenResolution\n  }\n\n  getFeatures(region: Region, opts: HicOptions = {}) {\n    return ObservableCreate<ContactRecord>(async observer => {\n      const { refName: chr, start, end } = region\n      const { resolution, bpPerPx = 1, statusCallback = () => {} } = opts\n      const res = await this.getResolution(bpPerPx / (resolution || 1000), opts)\n      statusCallback('Downloading .hic data')\n\n      const records = await this.hic.getContactRecords(\n        'KR',\n        { start, chr, end },\n        { start, chr, end },\n        'BP',\n        res,\n      )\n      records.forEach(record => {\n        observer.next(record)\n      })\n      statusCallback('')\n      observer.complete()\n    }, opts.signal) as any // eslint-disable-line @typescript-eslint/no-explicit-any\n  }\n\n  // don't do feature stats estimation, similar to bigwigadapter\n  async getMultiRegionFeatureDensityStats(_regions: Region[]) {\n    return { featureDensity: 0 }\n  }\n\n  freeResources(/* { region } */): void {}\n}\n"],"names":["GenericFilehandleWrapper","constructor","filehandle","read","position","length","buffer","b","bytesRead","this","Buffer","allocUnsafe","slice","byteOffset","openFilehandleWrapper","location","pluginManager","openLocation","HicAdapter","BaseFeatureDataAdapter","config","getSubAdapter","super","hic","hicLocation","getConf","HicStraw","file","setup","opts","statusCallback","result","getMetaData","getHeader","ret","chromosomes","rest","getRefNames","map","chr","name","getResolution","bpPerPx","resolutions","chosenResolution","at","i","r","getFeatures","region","arguments","undefined","ObservableCreate","async","refName","start","end","resolution","res","getContactRecords","forEach","record","observer","next","complete","signal","getMultiRegionFeatureDensityStats","_regions","featureDensity","freeResources"],"sourceRoot":""}