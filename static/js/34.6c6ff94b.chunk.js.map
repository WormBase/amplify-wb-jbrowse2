{"version":3,"file":"static/js/34.6c6ff94b.chunk.js","mappings":"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","sources":["../../../plugins/gff3/src/Gff3Adapter/Gff3Adapter.ts"],"sourcesContent":["import {\n  BaseFeatureDataAdapter,\n  BaseOptions,\n} from '@jbrowse/core/data_adapters/BaseAdapter'\nimport { NoAssemblyRegion } from '@jbrowse/core/util/types'\nimport { openLocation } from '@jbrowse/core/util/io'\nimport { ObservableCreate } from '@jbrowse/core/util/rxjs'\nimport IntervalTree from '@flatten-js/interval-tree'\nimport SimpleFeature, { Feature } from '@jbrowse/core/util/simpleFeature'\nimport { unzip } from '@gmod/bgzf-filehandle'\n\nimport gff, { GFF3FeatureLineWithRefs } from '@gmod/gff'\n\nfunction isGzip(buf: Buffer) {\n  return buf[0] === 31 && buf[1] === 139 && buf[2] === 8\n}\n\nexport default class extends BaseFeatureDataAdapter {\n  protected gffFeatures?: Promise<{\n    header: string\n    intervalTree: Record<string, IntervalTree>\n  }>\n\n  private async loadDataP() {\n    const pm = this.pluginManager\n    const buf = await openLocation(this.getConf('gffLocation'), pm).readFile()\n    const buffer = isGzip(buf) ? await unzip(buf) : buf\n    // 512MB  max chrome string length is 512MB\n    if (buffer.length > 536_870_888) {\n      throw new Error('Data exceeds maximum string length (512MB)')\n    }\n    const data = new TextDecoder('utf8', { fatal: true }).decode(buffer)\n    const lines = data.split(/\\n|\\r\\n|\\r/)\n    const headerLines = []\n    for (let i = 0; i < lines.length && lines[i].startsWith('#'); i++) {\n      headerLines.push(lines[i])\n    }\n    const header = headerLines.join('\\n')\n\n    const feats = gff.parseStringSync(data, {\n      parseFeatures: true,\n      parseComments: false,\n      parseDirectives: false,\n      parseSequences: false,\n      disableDerivesFromReferences: true,\n    })\n\n    const intervalTree = {} as Record<string, IntervalTree>\n    for (const obj of feats.flat().map(\n      (f, i) =>\n        new SimpleFeature({\n          data: this.featureData(f),\n          id: `${this.id}-offset-${i}`,\n        }),\n    )) {\n      const key = obj.get('refName')\n      if (!intervalTree[key]) {\n        intervalTree[key] = new IntervalTree()\n      }\n      intervalTree[key].insert([obj.get('start'), obj.get('end')], obj)\n    }\n\n    return { header, intervalTree }\n  }\n\n  private async loadData() {\n    if (!this.gffFeatures) {\n      this.gffFeatures = this.loadDataP().catch(e => {\n        this.gffFeatures = undefined\n        throw e\n      })\n    }\n\n    return this.gffFeatures\n  }\n\n  public async getRefNames(_opts: BaseOptions = {}) {\n    const { intervalTree } = await this.loadData()\n    return Object.keys(intervalTree)\n  }\n\n  public async getHeader() {\n    const { header } = await this.loadData()\n    return header\n  }\n\n  public getFeatures(query: NoAssemblyRegion, opts: BaseOptions = {}) {\n    return ObservableCreate<Feature>(async observer => {\n      try {\n        const { start, end, refName } = query\n        const { intervalTree } = await this.loadData()\n        intervalTree[refName]\n          ?.search([start, end])\n          .forEach(f => observer.next(f))\n        observer.complete()\n      } catch (e) {\n        observer.error(e)\n      }\n    }, opts.signal)\n  }\n\n  private featureData(data: GFF3FeatureLineWithRefs) {\n    const f: Record<string, unknown> = { ...data }\n    ;(f.start as number) -= 1 // convert to interbase\n    if (data.strand === '+') {\n      f.strand = 1\n    } else if (data.strand === '-') {\n      f.strand = -1\n    } else if (data.strand === '.') {\n      f.strand = 0\n    } else {\n      f.strand = undefined\n    }\n    f.phase = Number(data.phase)\n    f.refName = data.seq_id\n    if (data.score === null) {\n      delete f.score\n    }\n    if (data.phase === null) {\n      delete f.score\n    }\n    const defaultFields = new Set([\n      'start',\n      'end',\n      'seq_id',\n      'score',\n      'type',\n      'source',\n      'phase',\n      'strand',\n    ])\n    const dataAttributes = data.attributes || {}\n    for (const a of Object.keys(dataAttributes)) {\n      let b = a.toLowerCase()\n      if (defaultFields.has(b)) {\n        // add \"suffix\" to tag name if it already exists\n        // reproduces behavior of NCList\n        b += '2'\n      }\n      if (dataAttributes[a] !== null) {\n        let attr: string | string[] | undefined = dataAttributes[a]\n        if (Array.isArray(attr) && attr.length === 1) {\n          ;[attr] = attr\n        }\n        f[b] = attr\n      }\n    }\n    f.refName = f.seq_id\n\n    // the SimpleFeature constructor takes care of recursively inflating subfeatures\n    if (data.child_features && data.child_features.length > 0) {\n      f.subfeatures = data.child_features.flatMap(childLocs =>\n        childLocs.map(childLoc => this.featureData(childLoc)),\n      )\n    }\n\n    delete f.child_features\n    delete f.data\n    // delete f.derived_features\n    delete f.attributes\n    delete f.seq_id\n    return f\n  }\n\n  public freeResources(/* { region } */) {}\n}\n"],"names":["isGzip","buf","_default","_BaseFeatureDataAdapt","_loadDataP","_loadData","_getRefNames","_getHeader","_inherits","_super","_createSuper","_this","_classCallCheck","_len","arguments","length","args","Array","_key","call","apply","concat","gffFeatures","_createClass","key","value","_asyncToGenerator","_regeneratorRuntime","mark","_callee","pm","buffer","data","lines","headerLines","i","header","feats","intervalTree","_iterator","_step","obj","_this2","wrap","_context","prev","next","this","pluginManager","openLocation","getConf","readFile","sent","unzip","t0","Error","TextDecoder","fatal","decode","split","startsWith","push","join","gff","parseStringSync","parseFeatures","parseComments","parseDirectives","parseSequences","disableDerivesFromReferences","_createForOfIteratorHelper","flat","map","f","SimpleFeature","featureData","id","s","n","done","get","IntervalTree","insert","err","e","abrupt","stop","_callee2","_this3","_context2","loadDataP","catch","undefined","_callee3","_yield$this$loadData","_args3","_context3","loadData","Object","keys","_callee4","_yield$this$loadData2","_context4","query","_ref","_this4","opts","ObservableCreate","_x","_callee5","observer","_intervalTree$refName","start","end","refName","_yield$_this4$loadDat","_context5","search","forEach","complete","error","signal","_this5","_objectSpread","strand","phase","Number","seq_id","score","defaultFields","Set","dataAttributes","attributes","_i","_Object$keys","a","b","toLowerCase","has","attr","isArray","_attr","_slicedToArray","child_features","subfeatures","flatMap","childLocs","childLoc","BaseFeatureDataAdapter"],"sourceRoot":""}